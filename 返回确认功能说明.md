# 返回确认功能说明

## ✅ 新增功能

### 1️⃣ 按钮文字优化
- ❌ 旧文字：`← 返回预览`
- ✅ 新文字：`← 返回`
- 📝 更简洁直观

### 2️⃣ 智能返回确认
当用户点击"返回"按钮时，系统会智能判断：

#### 场景 A：可以直接返回
**条件：**
- 用户没有编辑任何内容，或
- 用户已经点击过"导出"按钮

**行为：**
- ✅ 直接返回预览界面
- ✅ 无任何提示

#### 场景 B：需要确认
**条件：**
- 用户在画板上添加了标注、绘图等内容
- **且**尚未点击"导出"按钮

**行为：**
- ⚠️ 弹出确认对话框
- 📝 提示文字：**"返回后，当前已编辑内容会丢失，是否继续？"**
- 用户选择：
  - 点击"确定" → 返回预览，编辑内容丢失
  - 点击"取消" → 留在编辑器，继续编辑

---

## 🎯 使用场景

### 场景 1：只是看看，没有编辑

```
1. 打开图片编辑器
2. 查看图片
3. 没有画任何东西
4. 点击"返回"
   → ✅ 直接返回，无提示
```

### 场景 2：编辑了但已导出

```
1. 打开图片编辑器
2. 在图片上画了一些标注
3. 点击"导出"按钮 ← 重要！
4. 看到Toast："✅ 导出成功！"
5. 点击"返回"
   → ✅ 直接返回，无提示（因为已导出）
```

### 场景 3：编辑了但未导出

```
1. 打开图片编辑器
2. 在图片上画了一些标注
3. 忘记点击"导出"
4. 直接点击"返回"
   → ⚠️ 弹出确认对话框
   
   ┌─────────────────────────────────────┐
   │  返回后，当前已编辑内容会丢失，    │
   │  是否继续？                          │
   │                                      │
   │         [取消]      [确定]          │
   └─────────────────────────────────────┘
   
   选择"取消" → 留在编辑器
   选择"确定" → 返回预览，编辑丢失
```

---

## 🔧 技术实现

### 状态跟踪

```typescript
// 状态定义
const [hasExported, setHasExported] = useState(false);     // 是否已导出
const [hasEdited, setHasEdited] = useState(false);         // 是否已编辑
const [initialElementCount, setInitialElementCount] = useState(0);  // 初始元素数量
```

### 编辑检测

```typescript
// 在 Excalidraw 的 onChange 中检测
onChange={(elements, appState) => {
  // 如果元素数量大于初始数量（图片本身），说明用户添加了新内容
  if (initialElementCount > 0 && elements && elements.length > initialElementCount) {
    setHasEdited(true);  // 标记为已编辑
  }
}}
```

**逻辑说明：**
- 图片加载后，只有1个元素（图片本身）
- 用户添加标注后，元素数量 > 1
- 检测到元素数量增加 → 标记为已编辑

### 导出状态重置

```typescript
// 导出成功后
await targetField.setValue(recordId, updatedAttachments);
setHasExported(true);   // 标记已导出
setHasEdited(false);    // 重置编辑状态
```

### 返回确认逻辑

```typescript
const handleBack = () => {
  // 如果有编辑内容且未导出，提示用户
  if (hasEdited && !hasExported) {
    const confirmed = window.confirm('返回后，当前已编辑内容会丢失，是否继续？');
    if (!confirmed) {
      return;  // 用户选择取消，不返回
    }
  }
  onBack();  // 执行返回
};
```

---

## 📊 状态流转图

```
初始状态
  hasEdited: false
  hasExported: false
  initialElementCount: 0
    ↓
加载图片完成
  initialElementCount: 1
    ↓
用户开始编辑（添加标注）
  hasEdited: true  ← 触发！
    ↓
点击"导出"按钮
  hasExported: true
  hasEdited: false  ← 重置
    ↓
点击"返回"
  检查：hasEdited && !hasExported
  结果：false（因为 hasEdited = false）
  行为：直接返回 ✅
```

```
另一个场景：
    
用户开始编辑
  hasEdited: true
    ↓
未点击"导出"
  hasExported: false
    ↓
点击"返回"
  检查：hasEdited && !hasExported
  结果：true（有编辑且未导出）
  行为：弹出确认对话框 ⚠️
```

---

## 🎨 界面效果

### 确认对话框样式

```
背景遮罩（半透明黑色）
    ↓
┌─────────────────────────────────────┐
│                                      │
│  返回后，当前已编辑内容会丢失，    │
│  是否继续？                          │
│                                      │
│         [取消]      [确定]          │
│                                      │
└─────────────────────────────────────┘
```

**按钮说明：**
- **取消** - 返回编辑器，保留编辑内容
- **确定** - 返回预览，编辑内容丢失

---

## 💡 最佳实践

### 建议的工作流程

**方式 1：边编辑边导出**
```
1. 编辑图片
2. 导出到字段A  ← 保存版本1
3. 继续编辑
4. 导出到字段B  ← 保存版本2
5. 返回 ✅ 无提示（已导出）
```

**方式 2：多次尝试后导出**
```
1. 编辑图片
2. 觉得不满意，撤销重画
3. 再次编辑
4. 满意后导出
5. 返回 ✅ 无提示（已导出）
```

**方式 3：临时放弃**
```
1. 编辑图片
2. 发现原图不合适
3. 点击"返回"
4. 看到确认提示 ⚠️
5. 点击"确定"放弃编辑
6. 返回预览 ✅
```

---

## ⚠️ 注意事项

### 1. 什么情况会触发确认提示？

**会触发：** ✅
```
- 用户添加了绘图元素（线条、形状、文字等）
- 且没有点击"导出"按钮
- 然后点击"返回"
```

**不会触发：** ❌
```
- 只是打开编辑器看了看，没有编辑
- 编辑后已经点击了"导出"
- 加载图片本身不算编辑
```

### 2. 导出后的行为

```
用户编辑 → 导出成功 → 继续编辑 → 点击返回
                ↑
          重置编辑状态

结果：会再次触发确认（因为导出后又编辑了）
```

### 3. 多次导出

```
用户可以多次导出到不同字段：
1. 编辑 → 导出到字段A → 继续编辑
2. 继续编辑 → 导出到字段B → 继续编辑
3. 继续编辑 → 导出到字段C → 返回 ✅

每次导出后，编辑状态重置，可以继续编辑
```

---

## 🎬 完整流程演示

### 测试场景：忘记导出

**步骤：**
```bash
1. 选中"产品图片"单元格，点击编辑
2. 用红色铅笔画了一个圈 ← hasEdited = true
3. 画了一个箭头
4. 添加了文字"这里有问题"
5. 突然想起还有其他事，直接点击"返回"
   
   系统检测：
   - hasEdited = true ✓
   - hasExported = false ✓
   - 条件满足，弹出确认框！
   
   ┌─────────────────────────────────────┐
   │  返回后，当前已编辑内容会丢失，    │
   │  是否继续？                          │
   │                                      │
   │         [取消]      [确定]          │
   └─────────────────────────────────────┘
   
   用户点击"取消" → 留在编辑器
   想起来还没导出，继续操作
6. 选择"标注图片"字段
7. 点击"导出" ← hasExported = true, hasEdited = false
8. 看到Toast："✅ 导出成功！"
9. 再次点击"返回"
   
   系统检测：
   - hasEdited = false ✗
   - hasExported = true ✓
   - 条件不满足，直接返回 ✅
```

---

## 🔍 调试信息

如果需要调试，可以在代码中添加日志：

```typescript
console.log('编辑状态:', {
  hasEdited,
  hasExported,
  initialElementCount,
  currentElementCount: excalidrawAPI?.getSceneElements().length
});
```

---

## ✨ 用户体验提升

### Before（旧版本）
```
用户编辑了很多标注
↓
不小心点了返回
↓
直接返回，内容丢失
↓
用户：😱 我的标注呢？！
```

### After（新版本）
```
用户编辑了很多标注
↓
不小心点了返回
↓
弹出确认："返回后，当前已编辑内容会丢失，是否继续？"
↓
用户点击"取消"
↓
继续编辑，然后导出
↓
用户：😊 太好了，差点丢失工作成果！
```

---

## 🎊 总结

这个功能保护用户的编辑成果，避免意外丢失：

- ✅ 智能检测是否有未保存的编辑
- ✅ 友好的确认提示
- ✅ 给用户第二次选择的机会
- ✅ 提升整体用户体验

**功能已完成，访问 http://localhost:3001 体验！** 🚀

