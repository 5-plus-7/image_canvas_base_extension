# 功能说明 - 图片编辑与导出

## ✅ 已完成的所有改进

### 1️⃣ 标题显示字段名
- ✅ 顶栏标题不再是固定的"附件预览"
- ✅ 动态显示当前选中单元格的**列名**（字段名）
- 📝 例如：如果字段名是"产品图片"，顶栏就显示"产品图片"

### 2️⃣ 优化文件信息显示
- ✅ 移除了文件类型显示
- ✅ 现在只显示：**文件名** + **文件大小**
- 📝 更简洁清晰的信息展示

### 3️⃣ 画板默认工具设置
- ✅ 进入编辑器时，自动选中**铅笔工具**
- ✅ 默认颜色设置为**红色**
- 📝 可以直接开始标注，无需手动选择工具

### 4️⃣ 导出工具栏
- ✅ 画板顶部右侧新增导出工具栏
- ✅ **下拉菜单**：显示多维表内所有附件字段的列名
- ✅ **导出按钮**：一键导出标注后的图片到多维表格
- 📝 自动插入到当前行的指定列

---

## 🎨 新界面布局

### 预览页面
```
┌──────────────────────────────────────────┐
│ 产品图片                          1 / 3  │ ← 字段名（动态）
├──────────────────────────────────────────┤
│ 📄 product.png | 125.5 KB                │ ← 文件名 + 大小（无类型）
│                        [←] [→] [✏️ 编辑] │ ← 切换和编辑按钮
╞══════════════════════════════════════════╡
│                                          │
│         [图片预览内容]                   │
│                                          │
└──────────────────────────────────────────┘
```

### 编辑页面
```
┌──────────────────────────────────────────┐
│ [← 返回预览]  图片编辑器                 │ ← 第一行头部
├──────────────────────────────────────────┤
│ 导出到: [编辑后的图片▼]      [📤 导出]  │ ← 第二行导出工具栏
├──────────────────────────────────────────┤
│                                          │
│                                          │
│         Excalidraw 画板                  │
│         (默认铅笔工具，红色)             │
│                                          │
│                                          │
└──────────────────────────────────────────┘
```

---

## 🚀 完整使用流程

### 步骤 1：预览附件
1. 在多维表格中选中包含图片的附件单元格
2. 插件自动显示图片，顶栏显示字段名（如"产品图片"）
3. 可以看到文件名和大小信息

### 步骤 2：进入编辑模式
1. 点击顶栏右侧的 **"✏️ 编辑"** 按钮
2. 自动切换到画板编辑器
3. 图片自动加载到画板中央
4. **铅笔工具自动选中，颜色已设为红色**

### 步骤 3：标注图片
1. 直接使用铅笔在图片上绘制标注
2. 可以切换其他工具（箭头、文字、形状等）
3. 可以更改颜色、粗细等

### 步骤 4：导出到多维表格
1. 在顶部导出工具栏选择目标附件字段
   - 下拉菜单显示所有附件字段（如"编辑后的图片"、"标注图片"等）
2. 点击 **"📤 导出"** 按钮
3. 系统自动：
   - 将画布导出为PNG格式
   - 插入到**当前行**的**所选字段**
   - 显示"导出成功"提示

### 步骤 5：返回预览
1. 点击 **"← 返回预览"** 按钮
2. 回到附件预览界面

---

## 🔧 技术实现细节

### 1. 默认铅笔工具和红色
```typescript
// 在图片加载后自动设置
setTimeout(() => {
  excalidrawAPI.setActiveTool({ type: 'freedraw' }); // 铅笔工具
  excalidrawAPI.updateScene({
    appState: {
      currentItemStrokeColor: '#ff0000', // 红色
    }
  });
}, 100);
```

### 2. 获取附件字段列表
```typescript
const table = await bitable.base.getTable(tableId);
const fieldMetaList = await table.getFieldMetaListByType<IAttachmentFieldMeta>(
  FieldType.Attachment
);
```

### 3. 导出PNG到多维表格
```typescript
// 1. 导出画布为Blob
const blob = await exportToBlob({
  elements: excalidrawAPI.getSceneElements(),
  mimeType: 'image/png',
  appState: excalidrawAPI.getAppState(),
  files: excalidrawAPI.getFiles(),
});

// 2. 转换为File对象
const file = new File([blob], `edited_${Date.now()}.png`, { 
  type: 'image/png' 
});

// 3. 插入到指定单元格
const targetField = await table.getField<IAttachmentField>(selectedFieldId);
await targetField.setValue(recordId, file);
```

---

## 📊 数据流程图

```
用户选中单元格
    ↓
获取字段名 → 显示在顶栏标题
    ↓
点击"编辑"
    ↓
传递 (imageUrl, recordId, tableId)
    ↓
进入编辑器
    ↓
自动执行：
  - 加载图片到画板
  - 选中铅笔工具
  - 设置颜色为红色
  - 获取所有附件字段列表
    ↓
用户标注图片
    ↓
选择目标附件字段
    ↓
点击"导出"
    ↓
自动执行：
  - 导出画布为PNG
  - 转换为File对象
  - 插入到指定单元格（当前行，所选列）
    ↓
显示"导出成功"
```

---

## 💡 使用场景示例

### 场景 1：产品标注
1. 字段设置：
   - "产品原图"字段 - 存放原始图片
   - "标注图片"字段 - 存放标注后的图片
2. 使用流程：
   - 选中"产品原图"单元格
   - 点击编辑，用红色铅笔圈出重点
   - 选择"标注图片"字段
   - 点击导出

### 场景 2：设计反馈
1. 字段设置：
   - "设计稿"字段 - 存放设计图
   - "反馈图"字段 - 存放标注的反馈图
2. 使用流程：
   - 选中"设计稿"单元格
   - 用铅笔画圈，添加箭头和文字说明
   - 导出到"反馈图"字段

---

## ⚙️ 导出工具栏说明

### 下拉菜单
- **显示内容**：多维表格中所有附件类型的字段
- **默认选择**：第一个附件字段
- **可切换**：点击展开选择其他字段
- **智能过滤**：只显示附件字段，不显示其他类型字段

### 导出按钮
- **正常状态**：显示 "📤 导出"
- **导出中**：显示 "导出中..."（禁用状态）
- **禁用条件**：未选择字段时禁用
- **导出格式**：PNG格式
- **文件命名**：`edited_时间戳.png`

---

## ⚠️ 注意事项

### 1. 字段选择
- 下拉菜单只显示**附件类型**的字段
- 如果表格中没有其他附件字段，下拉菜单可能为空或只有一个选项
- 建议提前创建好目标附件字段

### 2. 导出位置
- 导出的图片会插入到**当前编辑的那一行**
- 列是**下拉菜单选择的附件字段**
- 如果该单元格已有附件，新图片会**追加到末尾**（不会覆盖）

### 3. 性能考虑
- 大尺寸画布导出可能需要几秒钟
- 导出时按钮会显示"导出中..."状态
- 请耐心等待导出完成提示

### 4. 兼容性
- 支持所有常见图片格式的编辑
- 导出格式固定为PNG
- 确保有附件字段的编辑权限

---

## 🎯 快速测试步骤

1. **准备数据**
   ```
   创建多维表格
   ├── 字段1: "原图"（附件类型）
   ├── 字段2: "编辑后"（附件类型）
   └── 添加一行记录，在"原图"中上传一张图片
   ```

2. **开始测试**
   ```
   1. 选中"原图"单元格
   2. 查看插件显示 → 应该显示"原图"作为标题
   3. 点击"编辑" → 进入画板，自动选中红色铅笔
   4. 在图片上画几笔
   5. 在下拉菜单选择"编辑后"字段
   6. 点击"导出" → 等待成功提示
   7. 在多维表格中查看"编辑后"字段 → 应该有新的图片
   ```

---

## 📝 更新日志

### v1.1.0 (2025-01-16)
- ✨ 标题改为显示字段名
- ✨ 移除文件类型显示
- ✨ 画板默认选中红色铅笔工具
- ✨ 新增导出工具栏
- ✨ 支持选择目标附件字段
- ✨ 一键导出标注图片到多维表格

**所有功能已完成！开始使用吧！** 🎉

