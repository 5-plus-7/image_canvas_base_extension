# 多维表格附件预览插件 - 项目说明

## 📋 项目概述

这是一个为飞书多维表格开发的边栏插件，主要功能是预览和编辑附件文件。当用户在多维表格中选中附件单元格时，可以在插件中直接查看文件内容，对于图片文件还支持使用Excalidraw进行编辑和标注。

## ✨ 核心功能

### 1. 附件预览
- **自动识别选中单元格**：使用 Base JS SDK 监听用户选择的单元格
- **类型判断**：自动识别是否为附件字段
- **图片预览**：支持所有常见图片格式的直接预览（PNG、JPG、GIF、WebP等）
- **文件信息展示**：对于非图片文件，显示文件名、类型、大小等详细信息
- **多文件切换**：支持通过左右按钮在多个附件之间切换

### 2. 图片编辑
- **一键编辑**：预览图片时点击"编辑"按钮即可进入编辑模式
- **Excalidraw集成**：使用专业的画板工具进行标注
- **便捷返回**：编辑完成后可快速返回预览界面

### 3. 智能提示
- **空状态提示**：未选中单元格时友好提示用户
- **类型错误提示**：选中非附件字段时给出明确指引
- **加载状态**：显示加载动画和错误信息
- **深色模式**：自动适配系统深色模式设置

## 🏗️ 技术架构

### 技术栈
```
- React 19          # 前端框架
- TypeScript        # 类型安全
- Vite             # 构建工具
- SCSS             # 样式预处理
- @lark-base-open/js-sdk  # 多维表格 SDK
- @excalidraw/excalidraw  # 画板编辑器
```

### 项目结构
```
sandbox1/
├── components/              # 组件目录
│   ├── AttachmentViewer.tsx    # 附件预览器（核心）
│   ├── AttachmentViewer.scss   # 预览器样式
│   ├── ImageEditor.tsx          # 图片编辑器
│   ├── ImageEditor.scss         # 编辑器样式
│   ├── MainApp.tsx              # 主应用（路由管理）
│   ├── MainApp.scss             # 主应用样式
│   ├── ExampleApp.tsx           # Excalidraw示例（保留）
│   └── sidebar/                 # 侧边栏组件（Excalidraw原有）
│
├── index.tsx                # 应用入口
├── index.html              # HTML模板
├── vite.config.mts         # Vite配置
├── tsconfig.json           # TypeScript配置
├── package.json            # 项目依赖
│
├── README.md               # 项目文档
├── 使用指南.md            # 详细使用说明
├── 快速开始.md            # 快速上手指南
└── 项目说明.md            # 本文档
```

## 🔧 核心实现

### 1. AttachmentViewer 组件

这是插件的核心组件，负责附件预览功能。

**主要功能**：
- 监听多维表格选中单元格变化
- 判断选中的是否为附件字段
- 获取附件数据和URL
- 渲染预览界面
- 处理多附件切换

**关键代码逻辑**：
```typescript
// 监听选中变化
useEffect(() => {
  loadAttachments();
  const off = bitable.base.onSelectionChange(() => {
    loadAttachments();
  });
  return () => off();
}, []);

// 加载附件
const loadAttachments = async () => {
  const selection = await bitable.base.getSelection();
  const table = await bitable.base.getTable(selection.tableId);
  const field = await table.getField(selection.fieldId);
  
  // 判断是否为附件字段
  if (fieldType !== FieldType.Attachment) {
    setIsAttachmentCell(false);
    return;
  }
  
  // 获取附件列表和URL
  const attachmentField = await table.getField<IAttachmentField>(selection.fieldId);
  const attachmentList = await attachmentField.getValue(selection.recordId);
  const urls = await attachmentField.getAttachmentUrls(selection.recordId);
};
```

### 2. MainApp 组件

管理预览和编辑两个页面的路由。

**状态管理**：
```typescript
const [viewMode, setViewMode] = useState<ViewMode>('viewer');
const [editingImageUrl, setEditingImageUrl] = useState<string>('');
```

**页面切换**：
- `viewer` 模式：显示 AttachmentViewer
- `editor` 模式：显示 ImageEditor

### 3. ImageEditor 组件

集成Excalidraw作为图片编辑器。

**简化集成**：
```typescript
<Excalidraw 
  excalidrawAPI={(api) => setExcalidrawAPI(api)}
  theme="light"
  name="图片编辑器"
  UIOptions={{
    canvasActions: {
      loadScene: false,
    }
  }}
/>
```

## 📊 数据流

```
多维表格单元格选中
    ↓
Base JS SDK 监听到变化
    ↓
获取 selection (tableId, fieldId, recordId)
    ↓
判断字段类型
    ↓
[附件字段] → 获取附件列表 → 显示预览
    ↓
[图片类型] → 显示编辑按钮
    ↓
点击编辑 → 切换到 Excalidraw 编辑器
    ↓
点击返回 → 切换回预览界面
```

## 🎨 UI/UX 设计

### 设计原则
1. **符合飞书设计规范**：参考 Base-extension-design-guidelines.md
2. **响应式布局**：适配不同宽度的侧边栏
3. **清晰的信息层级**：头部、内容区、操作区分明
4. **友好的空状态**：明确的提示和引导
5. **深色模式支持**：自动适配系统主题

### 样式特点
- 使用飞书的色板系统（N系列中性色、B系列品牌色）
- 圆角统一使用 4px、6px、8px
- 按钮高度遵循 28px、32px、40px 规范
- 间距使用 4 的倍数（4px、8px、12px、16px、20px）

## 🔌 Base JS SDK 使用

### 主要 API

#### 1. 监听选中变化
```typescript
bitable.base.onSelectionChange(() => {
  // 处理选中变化
});
```

#### 2. 获取选中信息
```typescript
const selection = await bitable.base.getSelection();
// { tableId, fieldId, recordId, viewId, baseId }
```

#### 3. 获取表和字段
```typescript
const table = await bitable.base.getTable(tableId);
const field = await table.getField<IAttachmentField>(fieldId);
```

#### 4. 获取附件数据
```typescript
// 获取附件列表
const attachments = await attachmentField.getValue(recordId);

// 获取附件URL（有效期10分钟）
const urls = await attachmentField.getAttachmentUrls(recordId);
```

## 📦 构建和部署

### 开发模式
```bash
yarn start
# 访问 http://localhost:3001
```

### 生产构建
```bash
yarn build
# 输出到 dist/ 目录
```

### 部署要点
1. **相对路径**：vite.config.mts 中设置 `base: './'`
2. **HTTPS协议**：生产环境必须使用HTTPS
3. **跨域配置**：确保允许在多维表格iframe中加载

### 推荐部署平台
- Vercel（推荐）
- Netlify
- 自建服务器

## ⚠️ 注意事项

### 1. 附件URL有效期
- Base SDK返回的附件URL有效期为**10分钟**
- 超时后需要重新选择单元格刷新URL

### 2. 权限问题
- 插件权限与当前登录用户权限一致
- 无权限访问的附件会加载失败

### 3. 性能优化
- 大文件预览可能较慢
- 建议对图片尺寸进行限制
- 多个附件时采用懒加载策略

### 4. 浏览器兼容性
- 建议使用 Chrome、Edge 等现代浏览器
- Safari 可能存在部分兼容性问题

## 🚀 后续优化方向

### 功能增强
1. [ ] 支持编辑后保存图片回多维表格
2. [ ] 支持PDF文件预览
3. [ ] 支持音视频文件播放
4. [ ] 支持文档在线预览
5. [ ] 添加文件下载功能
6. [ ] 支持拖拽上传新附件

### 性能优化
1. [ ] 图片懒加载
2. [ ] 缩略图预加载
3. [ ] 虚拟滚动支持
4. [ ] 文件缓存策略

### 用户体验
1. [ ] 添加键盘快捷键
2. [ ] 支持全屏预览
3. [ ] 添加缩放和旋转功能
4. [ ] 优化移动端体验

## 📄 相关文档

- [README.md](./README.md) - 项目介绍和技术文档
- [使用指南.md](./使用指南.md) - 详细使用说明
- [快速开始.md](./快速开始.md) - 快速上手指南
- [Base-extension-readme.md](./Base-extension-readme.md) - 多维表格插件开发指南
- [Base-js-sdk-docs.md](./Base-js-sdk-docs.md) - JS SDK API文档
- [Base-extension-design-guidelines.md](./Base-extension-design-guidelines.md) - 设计规范

## 🤝 贡献

欢迎提交 Issue 和 Pull Request！

## 📝 License

MIT

---

**开发时间**：2025-01-16  
**版本**：v1.0.0  
**维护者**：开发团队

